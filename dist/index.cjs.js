// https://github.com/stardisblue/fsac v1.0.0 Copyright (c) 2021 Fati CHEN

"use strict";function t(t,i,r,h,a){n(t,i,r||0,h||t.length-1,a||e)}function n(t,e,r,h,a){for(;h>r;){if(h-r>600){var s=h-r+1,o=e-r+1,l=Math.log(s),c=.5*Math.exp(2*l/3),m=.5*Math.sqrt(l*c*(s-c)/s)*(o-s/2<0?-1:1);n(t,e,Math.max(r,Math.floor(e-o*c/s+m)),Math.min(h,Math.floor(e+(s-o)*c/s+m)),a)}var u=t[e],f=r,x=h;for(i(t,r,e),a(t[h],u)>0&&i(t,r,h);f<x;){for(i(t,f,x),f++,x--;a(t[f],u)<0;)f++;for(;a(t[x],u)>0;)x--}0===a(t[r],u)?i(t,r,x):i(t,++x,h),x<=e&&(r=x+1),e<=x&&(h=x-1)}}function i(t,n,i){var e=t[n];t[n]=t[i],t[i]=e}function e(t,n){return t<n?-1:t>n?1:0}Object.defineProperty(exports,"__esModule",{value:!0});function r(t,n,i){if(!i)return n.indexOf(t);for(let e=0;e<n.length;e++)if(i(t,n[e]))return e;return-1}function h(t,n){a(t,0,t.children.length,n,t)}function a(t,n,i,e,r){r||(r=d(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let h=n;h<i;h++){const n=t.children[h];s(r,t.leaf?e(n):n)}return r}function s(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function o(t,n){return t.minX-n.minX}function l(t,n){return t.minY-n.minY}function c(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function m(t){return t.maxX-t.minX+(t.maxY-t.minY)}function u(t,n){const i=Math.max(t.minX,n.minX),e=Math.max(t.minY,n.minY),r=Math.min(t.maxX,n.maxX),h=Math.min(t.maxY,n.maxY);return Math.max(0,r-i)*Math.max(0,h-e)}function f(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function x(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function d(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(n,i,e,r,h){const a=[i,e];for(;a.length;){if((e=a.pop())-(i=a.pop())<=r)continue;const s=i+Math.ceil((e-i)/r/2)*r;t(n,s,i,e,h),a.push(i,s,s,e)}}function M(t){return{minX:t.x-t.r,minY:t.y-t.r,maxX:t.x+t.r,maxY:t.y+t.r}}function g(t,n){const i=t.x*t.n+n.x*n.n,e=t.y*t.n+n.y*n.n,r=t.n+n.n;return function(t,n,i,e,r=null){const h={x:t,y:n,r:Math.sqrt(i),n:i,children:e};r&&(h.data=r);return h}(i/r,e/r,r,[t,n])}function X(t,n){return(t.r+n.r)**2-((t.x-n.x)**2+(t.y-n.y)**2)}function Y(t){return{v:t}}class _ extends class{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const i=[];if(!x(t,n))return i;const e=this.toBBox,r=[];for(;n;){for(let h=0;h<n.children.length;h++){const a=n.children[h],s=n.leaf?e(a):a;x(t,s)&&(n.leaf?i.push(a):f(t,s)?this._all(a,i):r.push(a))}n=r.pop()}return i}collides(t){let n=this.data;if(!x(t,n))return!1;const i=[];for(;n;){for(let e=0;e<n.children.length;e++){const r=n.children[e],h=n.leaf?this.toBBox(r):r;if(x(t,h)){if(n.leaf||f(t,h))return!0;i.push(r)}}n=i.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const t=this.data;this.data=n,n=t}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=d([]),this}remove(t,n){if(!t)return this;let i=this.data;const e=this.toBBox(t),h=[],a=[];let s,o,l;for(;i||h.length;){if(i||(i=h.pop(),o=h[h.length-1],s=a.pop(),l=!0),i.leaf){const e=r(t,i.children,n);if(-1!==e)return i.children.splice(e,1),h.push(i),this._condense(h),this}l||i.leaf||!f(i,e)?o?(s++,i=o.children[s],l=!1):i=null:(h.push(i),a.push(s),s=0,o=i,i=i.children[0])}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const i=[];for(;t;)t.leaf?n.push(...t.children):i.push(...t.children),t=i.pop();return n}_build(t,n,i,e){const r=i-n+1;let a,s=this._maxEntries;if(r<=s)return a=d(t.slice(n,i+1)),h(a,this.toBBox),a;e||(e=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,e-1))),a=d([]),a.leaf=!1,a.height=e;const o=Math.ceil(r/s),l=o*Math.ceil(Math.sqrt(s));p(t,n,i,l,this.compareMinX);for(let r=n;r<=i;r+=l){const n=Math.min(r+l-1,i);p(t,r,n,o,this.compareMinY);for(let i=r;i<=n;i+=o){const r=Math.min(i+o-1,n);a.children.push(this._build(t,i,r,e-1))}}return h(a,this.toBBox),a}_chooseSubtree(t,n,i,e){for(;e.push(n),!n.leaf&&e.length-1!==i;){let i,e=1/0,a=1/0;for(let s=0;s<n.children.length;s++){const o=n.children[s],l=c(o),m=(r=t,h=o,(Math.max(h.maxX,r.maxX)-Math.min(h.minX,r.minX))*(Math.max(h.maxY,r.maxY)-Math.min(h.minY,r.minY))-l);m<a?(a=m,e=l<e?l:e,i=o):m===a&&l<e&&(e=l,i=o)}n=i||n.children[0]}var r,h;return n}_insert(t,n,i){const e=i?t:this.toBBox(t),r=[],h=this._chooseSubtree(e,this.data,n,r);for(h.children.push(t),s(h,e);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(e,r,n)}_split(t,n){const i=t[n],e=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,e);const a=this._chooseSplitIndex(i,r,e),s=d(i.children.splice(a,i.children.length-a));s.height=i.height,s.leaf=i.leaf,h(i,this.toBBox),h(s,this.toBBox),n?t[n-1].children.push(s):this._splitRoot(i,s)}_splitRoot(t,n){this.data=d([t,n]),this.data.height=t.height+1,this.data.leaf=!1,h(this.data,this.toBBox)}_chooseSplitIndex(t,n,i){let e,r=1/0,h=1/0;for(let s=n;s<=i-n;s++){const n=a(t,0,s,this.toBBox),o=a(t,s,i,this.toBBox),l=u(n,o),m=c(n)+c(o);l<r?(r=l,e=s,h=m<h?m:h):l===r&&m<h&&(h=m,e=s)}return e||i-n}_chooseSplitAxis(t,n,i){const e=t.leaf?this.compareMinX:o,r=t.leaf?this.compareMinY:l;this._allDistMargin(t,n,i,e)<this._allDistMargin(t,n,i,r)&&t.children.sort(e)}_allDistMargin(t,n,i,e){t.children.sort(e);const r=this.toBBox,h=a(t,0,n,r),o=a(t,i-n,i,r);let l=m(h)+m(o);for(let e=n;e<i-n;e++){const n=t.children[e];s(h,t.leaf?r(n):n),l+=m(h)}for(let e=i-n-1;e>=n;e--){const n=t.children[e];s(o,t.leaf?r(n):n),l+=m(o)}return l}_adjustParentBBoxes(t,n,i){for(let e=i;e>=0;e--)s(n[e],t)}_condense(t){for(let n,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(n=t[i-1].children,n.splice(n.indexOf(t[i]),1)):this.clear():h(t[i],this.toBBox)}}{toBBox(t){return M(t.v)}compareMinX(t,n){return t.v.x-t.v.r-(n.v.x-n.v.r)}compareMinY(t,n){return t.v.y-t.v.r-(n.v.y-n.v.r)}}exports.CircleRbush=_,exports.default=function(t,{merge:n=g,overlap:i=X,bbox:e=M,Rbush:r=_,brk:h=!1,reverse:a=!1,sort:s=!0}={}){const o=t.map(Y),l=new Set(o),c=new r;c.load(o);for(const t of l){let r=!1,o=!0,m=t.v;for(;o;){o=!1;const u=c.search(e(m)),f=new Uint32Array(u.length);{const t=new Float64Array(u.length);u.forEach(((n,e)=>{f[e]=e,t[e]=i(m,n.v)})),s&&f.sort(((n,i)=>t[i]-t[n]))}const x=a?f.reverse():f;for(const e of x){const a=u[e];if(t!==a&&(i(m,a.v)>0&&(r||(r=!0),m=n(m,a.v),l.delete(a),c.remove(a),o||(o=!0),h)))break}}r&&(c.remove(t),t.v=m,c.insert(t))}return Array.from(l,(({v:t})=>t))},exports.ref=Y;
