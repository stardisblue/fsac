// https://github.com/stardisblue/fsac v1.0.1 Copyright (c) 2021 Fati CHEN

!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).fsac={})}(this,(function(t){"use strict";function n(t){return{v:t}}function e(t,n,e,r,h){i(t,n,e||0,r||t.length-1,h||o)}function i(t,n,e,o,h){for(;o>e;){if(o-e>600){var a=o-e+1,s=n-e+1,l=Math.log(a),c=.5*Math.exp(2*l/3),f=.5*Math.sqrt(l*c*(a-c)/a)*(s-a/2<0?-1:1);i(t,n,Math.max(e,Math.floor(n-s*c/a+f)),Math.min(o,Math.floor(n+(a-s)*c/a+f)),h)}var u=t[n],m=e,x=o;for(r(t,e,n),h(t[o],u)>0&&r(t,e,o);m<x;){for(r(t,m,x),m++,x--;h(t[m],u)<0;)m++;for(;h(t[x],u)>0;)x--}0===h(t[e],u)?r(t,e,x):r(t,++x,o),x<=n&&(e=x+1),n<=x&&(o=x-1)}}function r(t,n,e){var i=t[n];t[n]=t[e],t[e]=i}function o(t,n){return t<n?-1:t>n?1:0}function h(t,n,e){if(!e)return n.indexOf(t);for(let i=0;i<n.length;i++)if(e(t,n[i]))return i;return-1}function a(t,n){s(t,0,t.children.length,n,t)}function s(t,n,e,i,r){r||(r=g(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let o=n;o<e;o++){const n=t.children[o];l(r,t.leaf?i(n):n)}return r}function l(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function c(t,n){return t.minX-n.minX}function f(t,n){return t.minY-n.minY}function u(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function m(t){return t.maxX-t.minX+(t.maxY-t.minY)}function x(t,n){const e=Math.max(t.minX,n.minX),i=Math.max(t.minY,n.minY),r=Math.min(t.maxX,n.maxX),o=Math.min(t.maxY,n.maxY);return Math.max(0,r-e)*Math.max(0,o-i)}function d(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function p(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function g(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function M(t,n,i,r,o){const h=[n,i];for(;h.length;){if((i=h.pop())-(n=h.pop())<=r)continue;const a=n+Math.ceil((i-n)/r/2)*r;e(t,a,n,i,o),h.push(n,a,a,i)}}function X(t){return{minX:t.x-t.r,minY:t.y-t.r,maxX:t.x+t.r,maxY:t.y+t.r}}function Y(t,n){const e=t.x*t.n+n.x*n.n,i=t.y*t.n+n.y*n.n,r=t.n+n.n;return function(t,n,e,i,r=null){const o={x:t,y:n,r:Math.sqrt(e),n:e,children:i};r&&(o.data=r);return o}(e/r,i/r,r,[t,n])}function _(t,n){return(t.r+n.r)**2-((t.x-n.x)**2+(t.y-n.y)**2)}class B extends class{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const e=[];if(!p(t,n))return e;const i=this.toBBox,r=[];for(;n;){for(let o=0;o<n.children.length;o++){const h=n.children[o],a=n.leaf?i(h):h;p(t,a)&&(n.leaf?e.push(h):d(t,a)?this._all(h,e):r.push(h))}n=r.pop()}return e}collides(t){let n=this.data;if(!p(t,n))return!1;const e=[];for(;n;){for(let i=0;i<n.children.length;i++){const r=n.children[i],o=n.leaf?this.toBBox(r):r;if(p(t,o)){if(n.leaf||d(t,o))return!0;e.push(r)}}n=e.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const t=this.data;this.data=n,n=t}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=g([]),this}remove(t,n){if(!t)return this;let e=this.data;const i=this.toBBox(t),r=[],o=[];let a,s,l;for(;e||r.length;){if(e||(e=r.pop(),s=r[r.length-1],a=o.pop(),l=!0),e.leaf){const i=h(t,e.children,n);if(-1!==i)return e.children.splice(i,1),r.push(e),this._condense(r),this}l||e.leaf||!d(e,i)?s?(a++,e=s.children[a],l=!1):e=null:(r.push(e),o.push(a),a=0,s=e,e=e.children[0])}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const e=[];for(;t;)t.leaf?n.push(...t.children):e.push(...t.children),t=e.pop();return n}_build(t,n,e,i){const r=e-n+1;let o,h=this._maxEntries;if(r<=h)return o=g(t.slice(n,e+1)),a(o,this.toBBox),o;i||(i=Math.ceil(Math.log(r)/Math.log(h)),h=Math.ceil(r/Math.pow(h,i-1))),o=g([]),o.leaf=!1,o.height=i;const s=Math.ceil(r/h),l=s*Math.ceil(Math.sqrt(h));M(t,n,e,l,this.compareMinX);for(let r=n;r<=e;r+=l){const n=Math.min(r+l-1,e);M(t,r,n,s,this.compareMinY);for(let e=r;e<=n;e+=s){const r=Math.min(e+s-1,n);o.children.push(this._build(t,e,r,i-1))}}return a(o,this.toBBox),o}_chooseSubtree(t,n,e,i){for(;i.push(n),!n.leaf&&i.length-1!==e;){let e,i=1/0,h=1/0;for(let a=0;a<n.children.length;a++){const s=n.children[a],l=u(s),c=(r=t,o=s,(Math.max(o.maxX,r.maxX)-Math.min(o.minX,r.minX))*(Math.max(o.maxY,r.maxY)-Math.min(o.minY,r.minY))-l);c<h?(h=c,i=l<i?l:i,e=s):c===h&&l<i&&(i=l,e=s)}n=e||n.children[0]}var r,o;return n}_insert(t,n,e){const i=e?t:this.toBBox(t),r=[],o=this._chooseSubtree(i,this.data,n,r);for(o.children.push(t),l(o,i);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(i,r,n)}_split(t,n){const e=t[n],i=e.children.length,r=this._minEntries;this._chooseSplitAxis(e,r,i);const o=this._chooseSplitIndex(e,r,i),h=g(e.children.splice(o,e.children.length-o));h.height=e.height,h.leaf=e.leaf,a(e,this.toBBox),a(h,this.toBBox),n?t[n-1].children.push(h):this._splitRoot(e,h)}_splitRoot(t,n){this.data=g([t,n]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)}_chooseSplitIndex(t,n,e){let i,r=1/0,o=1/0;for(let h=n;h<=e-n;h++){const n=s(t,0,h,this.toBBox),a=s(t,h,e,this.toBBox),l=x(n,a),c=u(n)+u(a);l<r?(r=l,i=h,o=c<o?c:o):l===r&&c<o&&(o=c,i=h)}return i||e-n}_chooseSplitAxis(t,n,e){const i=t.leaf?this.compareMinX:c,r=t.leaf?this.compareMinY:f;this._allDistMargin(t,n,e,i)<this._allDistMargin(t,n,e,r)&&t.children.sort(i)}_allDistMargin(t,n,e,i){t.children.sort(i);const r=this.toBBox,o=s(t,0,n,r),h=s(t,e-n,e,r);let a=m(o)+m(h);for(let i=n;i<e-n;i++){const n=t.children[i];l(o,t.leaf?r(n):n),a+=m(o)}for(let i=e-n-1;i>=n;i--){const n=t.children[i];l(h,t.leaf?r(n):n),a+=m(h)}return a}_adjustParentBBoxes(t,n,e){for(let i=e;i>=0;i--)l(n[i],t)}_condense(t){for(let n,e=t.length-1;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():a(t[e],this.toBBox)}}{toBBox(t){return X(t.v)}compareMinX(t,n){return t.v.x-t.v.r-(n.v.x-n.v.r)}compareMinY(t,n){return t.v.y-t.v.r-(n.v.y-n.v.r)}}function v(t,{merge:e=Y,overlap:i=_,bbox:r=X,Rbush:o=B,brk:h=!1,reverse:a=!1,sort:s=!0}={}){const l=t.map(n),c=new Set(l),f=new o;f.load(l);for(const t of c){let n=!1,o=!0,l=t.v;for(;o;){o=!1;const u=f.search(r(l)),m=new Uint32Array(u.length);{const t=new Float64Array(u.length);u.forEach(((n,e)=>{m[e]=e,t[e]=i(l,n.v)})),s&&m.sort(((n,e)=>t[e]-t[n]))}const x=a?m.reverse():m;for(const r of x){const a=u[r];if(t!==a&&(i(l,a.v)>0&&(n||(n=!0),l=e(l,a.v),c.delete(a),f.remove(a),o||(o=!0),h)))break}}n&&(f.remove(t),t.v=l,f.insert(t))}return Array.from(c,(({v:t})=>t))}function b(t){return Math.pow(2,t)}function y(t,n){return function(e,i){const r=Y(e,i);return r._r=r.r,r.r/=t,r.at=n,r}}function w(t){return function(n){return n.r=n._r/t}}function E(t){return function(n){return{...n,_r:n.r,at:t}}}t.CircleRbush=B,t.bbox=X,t.circlePrepare=E,t.circleRescale=w,t.fsac=v,t.merge=Y,t.offlineCircleMerge=y,t.offlinefsac=function(t,{step:n=1,maxZoom:e=18,projection:i=b,rescale:r=w,merge:o=y,prepare:h=E,...a}={}){if(n<=0)throw new Error(`step should be greater than 0, got "${n}"`);if(e<0)throw new Error(`maxZoom should be at least equal to 0, got "${e}"`);let s=Array.from(t,h(e));for(let t=e;t>=0;t-=1/i(n-1)){const n=i(t);s.forEach(r(n)),s=v(s,{...a,merge:o(n,t)})}return s},t.overlap=_,t.powerTwoProjection=b,t.ref=n,Object.defineProperty(t,"__esModule",{value:!0})}));
